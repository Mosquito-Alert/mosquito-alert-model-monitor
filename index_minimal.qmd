---
title: "Mosquito Alert Model Monitor"
format:
  html:
    theme: cosmo
    css: styles.css
    toc: true
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(DT)
library(jsonlite)
library(dplyr)

# Simple function to load status files
load_status_files <- function() {
  status_files <- list.files("data/status", pattern = "*.json", full.names = TRUE)
  
  if (length(status_files) == 0) {
    return(data.frame())
  }
  
  # Read each file and combine
  all_data <- data.frame()
  for (file in status_files) {
    tryCatch({
      data <- jsonlite::fromJSON(file, flatten = TRUE)
      all_data <- rbind(all_data, data.frame(
        job_name = data$job_name %||% basename(file),
        status = data$status %||% "unknown",
        last_updated = data$last_updated %||% "",
        stringsAsFactors = FALSE
      ))
    }, error = function(e) {
      message("Error reading file: ", file)
    })
  }
  
  return(all_data)
}
```

# üìä **System Status**

## üéØ **Current Jobs** 

```{r simple-status}
jobs_data <- load_status_files()

if (nrow(jobs_data) > 0) {
  # Simple table with only trusted fields
  simple_status <- jobs_data %>%
    arrange(desc(last_updated)) %>%
    mutate(
      Status = case_when(
        status == "running" ~ "üîÑ Running",
        status == "completed" ~ "‚úÖ Completed", 
        status == "failed" ~ "‚ùå Failed",
        TRUE ~ paste("‚ö†Ô∏è", status)
      )
    ) %>%
    select(
      Job = job_name,
      Status,
      `Last Updated (Raw)` = last_updated
    )
  
  datatable(
    simple_status,
    options = list(
      pageLength = 15,
      dom = 't'
    ),
    rownames = FALSE,
    class = "table table-striped"
  )
} else {
  cat("**No jobs found.**")
}
```

## üìÅ **Data Files**

**Status Files Available:**

```{r file-list}
status_files <- list.files("data/status", pattern = "*.json", full.names = FALSE)
if (length(status_files) > 0) {
  for(file in status_files) {
    cat(paste0("- ", file, "\n"))
  }
} else {
  cat("No status files found.")
}
```

---

**This is a minimal dashboard showing only raw, unprocessed data to ensure reliability.**
