---
title: "Mosquito Alert Model Monitor"
format: 
  dashboard:
    theme: cosmo
    nav-buttons: [github]
    github: https://github.com/Mosquito-Alert/mosquito-alert-model-monitor
    scrolling: true
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false

library(jsonlite)
library(lubridate)
library(dplyr)
library(purrr)
library(DT)
library(plotly)
library(knitr)
library(htmltools)

# Function to load job status from JSON files
load_job_status <- function() {
  status_dir <- "data/status"
  if (!dir.exists(status_dir)) {
    return(data.frame())
  }
  
  json_files <- list.files(status_dir, pattern = "*.json", full.names = TRUE)
  
  if (length(json_files) == 0) {
    return(data.frame())
  }
  
  # Load each file individually and handle missing fields
  jobs_list <- list()
  
  for (i in seq_along(json_files)) {
    tryCatch({
      data <- fromJSON(json_files[i])
      
      # Ensure all required fields exist with defaults
      job_data <- data.frame(
        job_name = data$job_name %||% "unknown",
        status = data$status %||% "unknown",
        start_time = data$start_time %||% Sys.time(),
        end_time = data$end_time %||% NA,
        duration = data$duration %||% 0,
        progress = data$progress %||% 0,
        cpu_usage = data$cpu_usage %||% 0,
        memory_usage = data$memory_usage %||% 0,
        next_scheduled_run = data$next_scheduled_run %||% NA,
        file_modified = file.info(json_files[i])$mtime,
        config_file = basename(json_files[i]),
        stringsAsFactors = FALSE
      )
      
      # Handle log entries
      if (!is.null(data$log_entries) && length(data$log_entries) > 0) {
        job_data$latest_log <- tail(data$log_entries, 1)
      } else {
        job_data$latest_log <- "No logs available"
      }
      
      jobs_list[[i]] <- job_data
      
    }, error = function(e) {
      warning(paste("Error reading", json_files[i], ":", e$message))
    })
  }
  
  if (length(jobs_list) > 0) {
    return(do.call(rbind, jobs_list))
  } else {
    return(data.frame())
  }
}

# Helper function for null coalescing
`%||%` <- function(x, y) if (is.null(x)) y else x

# Load current job data
jobs <- load_job_status()

# Create summary statistics
if (nrow(jobs) > 0) {
  jobs$last_updated <- as.POSIXct(jobs$start_time)
  jobs$status_color <- case_when(
    jobs$status == "completed" ~ "success",
    jobs$status == "running" ~ "info", 
    jobs$status == "failed" ~ "danger",
    TRUE ~ "secondary"
  )
  
  total_jobs <- nrow(jobs)
  completed_jobs <- sum(jobs$status == "completed")
  running_jobs <- sum(jobs$status == "running")
  failed_jobs <- sum(jobs$status == "failed")
} else {
  total_jobs <- completed_jobs <- running_jobs <- failed_jobs <- 0
}
```

## {.sidebar}

**Last Updated:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

### Job Summary

- **Total Jobs:** `r total_jobs`
- **Completed:** `r completed_jobs`
- **Running:** `r running_jobs`  
- **Failed:** `r failed_jobs`

### Project Info

**Mosquito Alert Model Monitor** tracks automated data processing jobs running on computational clusters.

**Repository:** [mosquito_model_data_prep](https://github.com/Mosquito-Alert/mosquito_model_data_prep)

## Overview

### Current Status

```{r}
if (nrow(jobs) > 0) {
  # Create status cards
  status_cards <- map_chr(1:nrow(jobs), function(i) {
    job <- jobs[i, ]
    
    status_icon <- case_when(
      job$status == "completed" ~ "âœ…",
      job$status == "running" ~ "ðŸ”„",
      job$status == "failed" ~ "âŒ",
      TRUE ~ "â¸ï¸"
    )
    
    duration_text <- if (job$duration > 0) {
      paste0(round(job$duration / 60, 1), " min")
    } else {
      "..."
    }
    
    paste0('<div class="card mb-3">',
           '<div class="card-header">',
           '<h5>', status_icon, ' ', job$job_name, '</h5>',
           '</div>',
           '<div class="card-body">',
           '<p><strong>Status:</strong> ', job$status, '</p>',
           '<p><strong>Progress:</strong> ', job$progress, '%</p>',
           '<p><strong>Duration:</strong> ', duration_text, '</p>',
           '<p><strong>Last Updated:</strong> ', format(job$last_updated, "%Y-%m-%d %H:%M"), '</p>',
           '<div class="progress mb-2">',
           '<div class="progress-bar" role="progressbar" style="width: ', job$progress, '%"></div>',
           '</div>',
           '</div></div>')
  })
  
  HTML(paste(status_cards, collapse = ""))
} else {
  HTML('<div class="alert alert-warning">No job status data found.</div>')
}
```

### Recent Activity

```{r}
if (nrow(jobs) > 0) {
  # Show recent log entries
  recent_logs <- jobs %>%
    select(job_name, status, last_updated, latest_log) %>%
    mutate(
      time_ago = paste(round(as.numeric(difftime(Sys.time(), last_updated, units = "hours")), 1), "hours ago")
    ) %>%
    select(job_name, status, latest_log, time_ago)
  
  DT::datatable(
    recent_logs,
    colnames = c("Job", "Status", "Latest Log", "Time"),
    options = list(
      pageLength = 10,
      dom = 't',
      columnDefs = list(
        list(width = '20%', targets = 0),
        list(width = '15%', targets = 1),
        list(width = '50%', targets = 2),
        list(width = '15%', targets = 3)
      )
    ),
    rownames = FALSE
  )
} else {
  HTML('<div class="alert alert-info">No recent activity to display.</div>')
}
```

## Performance

### Job Status Distribution

```{r}
if (nrow(jobs) > 0) {
  status_summary <- jobs %>%
    count(status) %>%
    mutate(percentage = round(n / sum(n) * 100, 1))
  
  p <- plot_ly(
    status_summary,
    labels = ~status,
    values = ~n,
    type = 'pie',
    textinfo = 'label+percent',
    marker = list(
      colors = c("completed" = "#28a745", "running" = "#17a2b8", "failed" = "#dc3545", "not_run" = "#6c757d")
    )
  ) %>%
    layout(
      title = "Job Status Distribution",
      showlegend = FALSE
    )
  
  p
} else {
  HTML('<div class="alert alert-info">No data available for visualization.</div>')
}
```

### Progress Overview

```{r}
if (nrow(jobs) > 0) {
  progress_data <- jobs %>%
    select(job_name, progress, status) %>%
    mutate(
      progress_color = case_when(
        status == "completed" ~ "#28a745",
        status == "running" ~ "#17a2b8",
        status == "failed" ~ "#dc3545",
        TRUE ~ "#6c757d"
      )
    )
  
  p <- plot_ly(
    progress_data,
    x = ~job_name,
    y = ~progress,
    type = 'bar',
    marker = list(color = ~progress_color),
    text = ~paste(progress, "%"),
    textposition = 'auto'
  ) %>%
    layout(
      title = "Job Progress",
      xaxis = list(title = "Job"),
      yaxis = list(title = "Progress (%)", range = c(0, 100)),
      showlegend = FALSE
    )
  
  p
} else {
  HTML('<div class="alert alert-info">No progress data available.</div>')
}
```

## Log Files

### Recent Log Output

```{r}
# Load and display recent log files
log_dir <- "data/details"
if (dir.exists(log_dir)) {
  log_files <- list.files(log_dir, pattern = "*.log", full.names = TRUE)
  
  if (length(log_files) > 0) {
    # Show a subset of most recent/relevant logs
    key_logs <- log_files[grepl("mosquito_alert_cleaned_reports|user_locations|z4_bite", log_files)]
    
    if (length(key_logs) > 0) {
      log_content <- map_chr(key_logs[1:min(3, length(key_logs))], function(log_file) {
        file_name <- basename(log_file)
        content <- readLines(log_file, n = 20, warn = FALSE)
        content <- paste(content, collapse = "\n")
        
        paste0('<div class="card mb-3">',
               '<div class="card-header"><strong>', file_name, '</strong></div>',
               '<div class="card-body">',
               '<pre style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">', 
               htmlEscape(content), 
               '</pre></div></div>')
      })
      
      HTML(paste(log_content, collapse = ""))
    } else {
      HTML('<div class="alert alert-info">No key log files found.</div>')
    }
  } else {
    HTML('<div class="alert alert-warning">No log files available.</div>')
  }
} else {
  HTML('<div class="alert alert-warning">Log directory not found.</div>')
}
```

### Available Log Files

```{r}
if (dir.exists(log_dir)) {
  log_files <- list.files(log_dir, pattern = "*.log")
  
  if (length(log_files) > 0) {
    # Create a table of available log files
    log_table <- data.frame(
      `Log File` = log_files,
      `Last Modified` = map_chr(file.path(log_dir, log_files), function(f) {
        format(file.info(f)$mtime, "%Y-%m-%d %H:%M")
      }),
      `Size (KB)` = map_dbl(file.path(log_dir, log_files), function(f) {
        round(file.info(f)$size / 1024, 1)
      }),
      stringsAsFactors = FALSE
    )
    
    DT::datatable(
      log_table,
      options = list(
        pageLength = 10,
        dom = 'tp',
        columnDefs = list(
          list(width = '60%', targets = 0),
          list(width = '25%', targets = 1),
          list(width = '15%', targets = 2)
        )
      ),
      rownames = FALSE
    )
  } else {
    HTML('<div class="alert alert-info">No log files to display.</div>')
  }
} else {
  HTML('<div class="alert alert-warning">Log directory not found.</div>')
}
```
